---
- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    - role_name: ""
    - role_path: ""
    - role_prefix: 'ansible'
    - update: false
  tasks:
    - name: Verify user input for required variables
      assert:
        that:
          - role_name != ""
          - role_path != ""
          - role_prefix in ['ansible', 'galaxy', 'silpion', 'infra']

    - name: Set role_name_nodash
      set_fact:
        role_name_nodash="{{ role_name | replace("-","") }}"

    - name: Install Ansible role
      local_action: command ansible-galaxy init --init-path {{ role_path }} {{ role_prefix }}-{{ role_name }}
        creates={{ role_path }}/{{ role_prefix}}-{{ role_name }}

    - name: Install .gitignore
      local_action: copy
        mode=0600
        force=false
        src=files/.gitignore
        dest={{ role_path }}/{{ role_prefix}}-{{ role_name }}/.gitignore

    - name: Install static files
      with_items:
        - CHANGELOG.md
        - LICENSE
        - VERSION
      local_action: copy
        mode=0600
        force=false
        src=files/{{ item }}
        dest={{ role_path }}/{{ role_prefix }}-{{ role_name }}/{{ item }}

    - name: Install directories
      with_items:
        - rake
        - scripts
        - spec/default
        - spec/lib
        - tests
      local_action: file
        state=directory
        dest={{ role_path }}/{{ role_prefix}}-{{ role_name }}/{{ item }}

    - name: Install static files for TDD
      with_items:
        - ansible.cfg
        - Gemfile
        - rake/docker.rb
        - Rakefile
        - spec/lib/docker.rb
        - spec/lib/vagrant.rb
        - spec/spec_helper.rb
        - tests/hosts
        - tests/silpion-insecure-private-key
        - .travis.yml
      local_action: copy
        mode=0600
        src=files/{{ item }}
        dest={{ role_path }}/{{ role_prefix}}-{{ role_name }}/{{ item }}

    - name: Install templates
      with_items:
        - README.md
        - tests/playbook.yml
        - vars/main.yml
      when: not update
      local_action: template
        mode=0600
        src=templates/{{ item }}.j2
        dest={{ role_path }}/{{ role_prefix}}-{{ role_name }}/{{ item }}

    - name: Install templates for TDD
      with_items:
        - tests/docker.yml
        - Vagrantfile
        - envvars-vagrant.sample
        - rake/vagrant.rb
      local_action: template
        mode=0600
        src=templates/{{ item }}.j2
        dest={{ role_path }}/{{ role_prefix}}-{{ role_name }}/{{ item }}

    - name: Install spec integration test file
      local_action: copy
        mode=0600
        force=false
        src=files/spec/default/rolename_spec.rb
        dest={{ role_path }}/{{ role_prefix}}-{{ role_name }}/spec/default/{{ role_name }}_spec.rb

    - name: Install scripts
      with_items:
        - scripts/release.sh
      local_action: copy
        mode=0755
        src=files/{{ item }}
        dest={{ role_path }}/{{ role_prefix}}-{{ role_name }}/{{ item }}

    - name: git init...
      register: generater_git_init
      local_action: command git init
        chdir={{ role_path }}/{{ role_prefix}}-{{ role_name }}
        creates={{ role_path }}/{{ role_prefix}}-{{ role_name }}/.git

    - name: git add...
      register: generator_git_add
      when: generater_git_init.changed
      local_action: command git add .
        chdir={{ role_path }}/{{ role_prefix}}-{{ role_name }}

    - name: git commit...
      when: generator_git_add.changed
      local_action: command git commit -m 'Root commit (ansible-generator)'
        chdir={{ role_path }}/{{ role_prefix}}-{{ role_name }}

    - name: echo {{ role_path }}/{{ role_prefix }}-{{ role_name }}
      local_action: debug
        msg="Find the Ansible role at {{ role_path }}/{{ role_prefix }}-{{ role_name }}"
